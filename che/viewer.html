<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>講義ファイル閲覧｜学習小屋</title>
  <link rel="stylesheet" href="../common/style.css" />
  <style>
    html, body { height:100%; width:100%; margin:0; background:#000; overflow:hidden; }
    /* 返回按钮 */
    .overlay { position:fixed; top:14px; left:14px; z-index:30; }
    .btn { display:inline-block; padding:8px 14px; border:1px solid #fff; border-radius:8px; color:#fff; text-decoration:none; font-size:14px; background:rgba(255,255,255,.08); }
    /* PDF 容器 */
    #pdfFrame { width:100vw; height:100vh; border:none; background:#fff; }
    /* 加载遮罩 */
    #loader {
      position:fixed; inset:0; z-index:20; display:flex; align-items:center; justify-content:center;
      flex-direction:column; gap:14px; color:#fff; background:linear-gradient(135deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
      text-align:center; padding:24px;
    }
    .spin {
      width: 48px; height: 48px; border-radius: 50%;
      border: 4px solid rgba(255,255,255,.25); border-top-color:#fff;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hint { opacity:.9; font-size:.95rem; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
    .btn-primary { border-color:#4a90e2; background:#4a90e2; }
  </style>
</head>
<body>
  <!-- 顶部返回：自动回到对应列表 -->
  <div class="overlay"><a id="backBtn" class="btn">← 一覧に戻る</a></div>

  <!-- PDF -->
  <iframe id="pdfFrame" title="PDF Viewer"></iframe>

  <!-- 加载指示 & 超时兜底 -->
  <div id="loader" aria-live="polite" aria-busy="true">
    <div class="spin" aria-hidden="true"></div>
    <div id="loadMsg">講義ファイルを読み込み中です…</div>
    <div class="hint" id="loadHint">通信状況により 1〜2 秒かかることがあります。</div>
    <div class="actions" style="display:none" id="slowActions">
      <a id="openDirect" class="btn btn-primary" target="_self">📄 直接開く</a>
      <button id="retryBtn" class="btn">↻ 再読み込み</button>
    </div>
  </div>

  <script>
    // —— 映射表（相对 /che/viewer.html；注意没有 ../）——
    const FILES = {
      '2510_1': 'assets/lectures/2510/chem_1.pdf',
      '2510_2': 'assets/lectures/2510/chem_2.pdf',
      '2510_3': 'assets/lectures/2510/chem_3.pdf'
    };

    const qs = new URLSearchParams(location.search);
    const id = qs.get('id') || '';
    const path = FILES[id];

    const frame = document.getElementById('pdfFrame');
    const loader = document.getElementById('loader');
    const loadMsg = document.getElementById('loadMsg');
    const loadHint = document.getElementById('loadHint');
    const slowActions = document.getElementById('slowActions');
    const openDirect = document.getElementById('openDirect');
    const retryBtn = document.getElementById('retryBtn');
    const backBtn = document.getElementById('backBtn');

    // 返回目标：优先 referrer，再看 id 前缀
    let back = './lectures.html';
    const ref = document.referrer || '';
    if (ref.includes('list-2507.html')) back = './list-2507.html';
    else if (ref.includes('list-2510.html')) back = './list-2510.html';
    else if (/^2507_/.test(id)) back = './list-2507.html';
    else if (/^2510_/.test(id)) back = './list-2510.html';
    backBtn.href = back;

    if (!path) {
      // 没有有效文件：直接回退
      loadMsg.textContent = '対象の講義が見つかりません。';
      loadHint.textContent = '一覧に戻って別の資料を選択してください。';
      slowActions.style.display = 'flex';
      openDirect.textContent = '← 一覧に戻る';
      openDirect.href = back;
    } else {
      document.title = `講義ファイル (${id})｜学習小屋`;
      openDirect.href = path;

      // —— 手机端：直接跳直链（系统查看器分页更好）——
      const ua = navigator.userAgent || navigator.vendor || window.opera;
      const isMobile = /iPhone|iPad|iPod|Android/i.test(ua);
      if (isMobile) {
        loadMsg.textContent = 'モバイル環境のため、ネイティブビューアで開きます…';
        location.replace(path);
      } else {
        // —— 桌面端：页内嵌入 + 友好加载反馈 —— 
        const t0 = performance.now();
        frame.src = path;

        // 3 秒仍未加载：提示“仍在加载”，展示直链/重试
        const slowTimer = setTimeout(() => {
          loadMsg.textContent = 'まだ読み込み中です…';
          loadHint.textContent = 'ネットワークが混み合っている可能性があります。下のボタンから直接開く/再読み込みもできます。';
          slowActions.style.display = 'flex';
        }, 3000);

        // 10 秒仍未完成：强调兜底
        const hardTimer = setTimeout(() => {
          loadMsg.textContent = '読み込みに時間がかかっています。';
          loadHint.textContent = '「📄 直接開く」を押すと同ページで表示します。';
          slowActions.style.display = 'flex';
        }, 10000);

        // 加载完成：关闭遮罩，给出耗时
        frame.addEventListener('load', () => {
          clearTimeout(slowTimer); clearTimeout(hardTimer);
          const cost = Math.max(0, Math.round((performance.now() - t0)/1000));
          loader.style.display = 'none';
          // 可选：把耗时写入标题，便于你调试
          // document.title += `（${cost}s）`;
        });

        // 明确的失败事件很少触发，但保底处理
        frame.addEventListener('error', () => {
          loadMsg.textContent = '読み込みに失敗しました。';
          loadHint.textContent = '「📄 直接開く」または「↻ 再読み込み」をお試しください。';
          slowActions.style.display = 'flex';
        });

        // 重试按钮：带一次性 cache-busting
        retryBtn.addEventListener('click', () => {
          slowActions.style.display = 'none';
          loadMsg.textContent = '再読み込み中…';
          const bust = (path.includes('?') ? '&' : '?') + 't=' + Date.now();
          frame.src = path + bust;
        });
      }
    }
  </script>
</body>
</html>
